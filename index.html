<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link href="styles/tailwind.min.css" rel="stylesheet">
    <link rel="shortcut icon" href="icons/favicon.svg"/>
    <title>Audio Player</title>
    <style>
        #volume::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            background: #1E3A8A;
            border-radius: 1.25rem;
            border: 0;
            cursor: pointer;
            transition: all .2s ease-out;
        }

        #volume::-webkit-slider-thumb:hover {
            transform: scale(1.25);
            background: #F59E0B;
        }

        #volume::-moz-range-thumb {
            width: 1.25rem;
            height: 1.25rem;
            background: #1E3A8A;
            border-radius: 1.25rem;
            border: 0;
            cursor: pointer;
            transition: all .2s ease-out;
        }

        #volume::-moz-range-thumb:hover {
            transform: scale(1.25);
            background: #F59E0B;
        }
    </style>
</head>
<body>
<audio id="audio" crossorigin="anonymous"></audio>
<div class="m-9 p-6 max-w-screen-md bg-blue-50 rounded-3xl space-y-9">
    <div id="visualization" class="w-full flex justify-center items-end"></div>

    <div id="songName" class="text-center h-20 text-3xl mb-9 overflow-x-scroll leading-10"></div>

    <div id="progressContainer" class="relative bg-blue-200 w-full rounded-full h-3.5 cursor-pointer">
        <div id="progressBar" class="bg-yellow-500 h-full rounded-full absolute top-0 left-0"></div>
    </div>

    <div id="controls" class="flex flex-wrap justify-center items-center text-blue-900 fill-current">
        <svg id="previousButton"
             class="cursor-pointer hover:text-yellow-500 transform hover:scale-125 transition-all ease-out duration-200 m-4"
             width="50px" height="50px" viewBox="0 0 24 24">
            <path d="M7 6c.55 0 1 .45 1 1v10c0 .55-.45 1-1 1s-1-.45-1-1V7c0-.55.45-1 1-1zm3.66 6.82l5.77 4.07c.66.47 1.58-.01 1.58-.82V7.93c0-.81-.91-1.28-1.58-.82l-5.77 4.07c-.57.4-.57 1.24 0 1.64z"></path>
        </svg>

        <svg id="playPauseButton"
             class="cursor-pointer hover:text-yellow-500 transform hover:scale-125 transition-all ease-out duration-200 m-4"
             width="60px" height="60px" viewBox="0 0 24 24">
            <path id="playPath"
                  d="M8 6.82v10.36c0 .79.87 1.27 1.54.84l8.14-5.18c.62-.39.62-1.29 0-1.69L9.54 5.98C8.87 5.55 8 6.03 8 6.82z"></path>
            <path id="pausePath" class="hidden"
                  d="M8 19c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2s-2 .9-2 2v10c0 1.1.9 2 2 2zm6-12v10c0 1.1.9 2 2 2s2-.9 2-2V7c0-1.1-.9-2-2-2s-2 .9-2 2z"></path>
        </svg>

        <svg id="nextButton"
             class="cursor-pointer hover:text-yellow-500 transform hover:scale-125 transition-all ease-out duration-200 m-4"
             width="50px" height="50px" viewBox="0 0 24 24">
            <path d="M7.58 16.89l5.77-4.07c.56-.4.56-1.24 0-1.63L7.58 7.11C6.91 6.65 6 7.12 6 7.93v8.14c0 .81.91 1.28 1.58.82zM16 7v10c0 .55.45 1 1 1s1-.45 1-1V7c0-.55-.45-1-1-1s-1 .45-1 1z"></path>
        </svg>

        <svg id="shuffleButton"
             class="cursor-pointer hover:text-yellow-500 transform hover:scale-125 transition-all ease-out duration-200 m-4"
             width="40px" height="40px" viewBox="0 0 24 24">
            <path d="M10.59 9.17L6.12 4.7a.9959.9959 0 00-1.41 0c-.39.39-.39 1.02 0 1.41l4.46 4.46 1.42-1.4zm4.76-4.32l1.19 1.19L4.7 17.88c-.39.39-.39 1.02 0 1.41.39.39 1.02.39 1.41 0L17.96 7.46l1.19 1.19c.31.31.85.09.85-.36V4.5c0-.28-.22-.5-.5-.5h-3.79c-.45 0-.67.54-.36.85zm-.52 8.56l-1.41 1.41 3.13 3.13-1.2 1.2c-.31.31-.09.85.36.85h3.79c.28 0 .5-.22.5-.5v-3.79c0-.45-.54-.67-.85-.35l-1.19 1.19-3.13-3.14z"></path>
        </svg>

        <svg id="volumeIcon"
             class="cursor-pointer hover:text-yellow-500 transform hover:scale-125 transition-all ease-out duration-200 m-4"
             width="45px" height="45px" viewBox="0 0 24 24">
            <path id="volumeMutePath" class="hidden"
                  d="M3.63 3.63c-.39.39-.39 1.02 0 1.41L7.29 8.7 7 9H4c-.55 0-1 .45-1 1v4c0 .55.45 1 1 1h3l3.29 3.29c.63.63 1.71.18 1.71-.71v-4.17l4.18 4.18c-.49.37-1.02.68-1.6.91-.36.15-.58.53-.58.92 0 .72.73 1.18 1.39.91.8-.33 1.55-.77 2.22-1.31l1.34 1.34c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L5.05 3.63c-.39-.39-1.02-.39-1.42 0zM19 12c0 .82-.15 1.61-.41 2.34l1.53 1.53c.56-1.17.88-2.48.88-3.87 0-3.83-2.4-7.11-5.78-8.4-.59-.23-1.22.23-1.22.86v.19c0 .38.25.71.61.85C17.18 6.54 19 9.06 19 12zm-8.71-6.29l-.17.17L12 7.76V6.41c0-.89-1.08-1.33-1.71-.7zM16.5 12c0-1.77-1.02-3.29-2.5-4.03v1.79l2.48 2.48c.01-.08.02-.16.02-.24z"></path>
            <path id="volumeHalfPath" class="hidden" transform="translate(-2, 0)"
                  d="M18.5 12c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM5 10v4c0 .55.45 1 1 1h3l3.29 3.29c.63.63 1.71.18 1.71-.71V6.41c0-.89-1.08-1.34-1.71-.71L9 9H6c-.55 0-1 .45-1 1z"></path>
            <path id="volumeFullPath"
                  d="M3 10v4c0 .55.45 1 1 1h3l3.29 3.29c.63.63 1.71.18 1.71-.71V6.41c0-.89-1.08-1.34-1.71-.71L7 9H4c-.55 0-1 .45-1 1zm13.5 2c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 4.45v.2c0 .38.25.71.6.85C17.18 6.53 19 9.06 19 12s-1.82 5.47-4.4 6.5c-.36.14-.6.47-.6.85v.2c0 .63.63 1.07 1.21.85C18.6 19.11 21 15.84 21 12s-2.4-7.11-5.79-8.4c-.58-.23-1.21.22-1.21.85z"></path>
        </svg>

        <input type="range" id="volume" value="1.0" min="0" max="1.5" step="0.01"
               class="w-40 cursor-pointer outline-none my-6 appearance-none bg-blue-200 h-2 rounded-full">

    </div>

    <div id="songList" class="divide-y"></div>

    <div id="songTemplate"
         class="hidden cursor-pointer px-9 py-3 hover:bg-blue-200 transition-all ease-in-out duration-300 rounded-2xl bg-opacity-30 flex justify-between items-center">
        <div class="songName">
            Song Name
        </div>
        <div class="songControls flex items-center text-blue-900 fill-current">
            <svg class="removeButton cursor-pointer hover:text-yellow-500 transform hover:scale-125 transition-all ease-out duration-200 mx-1"
                 width="30px" height="30px" viewBox="0 0 24 24">
                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V9c0-1.1-.9-2-2-2H8c-1.1 0-2 .9-2 2v10zm3.17-7.83c.39-.39 1.02-.39 1.41 0L12 12.59l1.42-1.42c.39-.39 1.02-.39 1.41 0 .39.39.39 1.02 0 1.41L13.41 14l1.42 1.42c.39.39.39 1.02 0 1.41-.39.39-1.02.39-1.41 0L12 15.41l-1.42 1.42c-.39.39-1.02.39-1.41 0a.9959.9959 0 010-1.41L10.59 14l-1.42-1.42c-.39-.38-.39-1.02 0-1.41zM15.5 4l-.71-.71c-.18-.18-.44-.29-.7-.29H9.91c-.26 0-.52.11-.7.29L8.5 4H6c-.55 0-1 .45-1 1s.45 1 1 1h12c.55 0 1-.45 1-1s-.45-1-1-1h-2.5z"></path>
            </svg>
            <svg class="moveUpButton cursor-pointer hover:text-yellow-500 transform hover:scale-125 transition-all ease-out duration-200 mx-1"
                 width="30px" height="30px" viewBox="0 0 24 24">
                <path d="M13 19V7.83l4.88 4.88c.39.39 1.03.39 1.42 0 .39-.39.39-1.02 0-1.41l-6.59-6.59a.9959.9959 0 00-1.41 0l-6.6 6.58c-.39.39-.39 1.02 0 1.41.39.39 1.02.39 1.41 0L11 7.83V19c0 .55.45 1 1 1s1-.45 1-1z"></path>
            </svg>
            <svg class="moveDownButton cursor-pointer hover:text-yellow-500 transform hover:scale-125 transition-all ease-out duration-200 mx-1"
                 width="30px" height="30px" viewBox="0 0 24 24">
                <path d="M11 5v11.17l-4.88-4.88c-.39-.39-1.03-.39-1.42 0-.39.39-.39 1.02 0 1.41l6.59 6.59c.39.39 1.02.39 1.41 0l6.59-6.59c.39-.39.39-1.02 0-1.41a.9959.9959 0 00-1.41 0L13 16.17V5c0-.55-.45-1-1-1s-1 .45-1 1z"></path>
            </svg>
        </div>
    </div>

    <div class="px-9 py-3 space-y-2 border-2 border-blue-200 rounded-2xl">
        <div class="m-1">
            Add file from web:
        </div>
        <div class="flex flex-wrap items-center">
            <div class="m-1">
                <input id="addSongUrl" type="text" placeholder="url"
                       class="w-full rounded-full px-3 py-1.5 outline-none">
            </div>

            <div class="m-1">
                <input id="addSongName" type="text" placeholder="name"
                       class="w-full rounded-full px-3 py-1.5 outline-none">
            </div>

            <button id="addSongFromWebButton"
                    class="px-3 py-1.5 m-1 bg-blue-200 rounded-full transition-all ease-in-out duration-300 text-xs hover:bg-yellow-500">
                ADD
            </button>
        </div>
        <div class="text-xs opacity-50">
            <p>The hosting server must allow cross-origin resource sharing.</p>
            <p>The <a href="https://archive.org" target="_blank" class="text-blue-700">Internet
                Archive</a>, for example, is a good source of audio files.</p>
        </div>
    </div>

    <div class="px-9 py-3 space-y-2 border-2 border-blue-200 rounded-2xl">
        <div class="m-1">
            Add local files:
        </div>
        <div class="flex flex-wrap items-center">
            <input id="localFileInput" type="file" multiple>

            <button id="addSongLocalButton"
                    class="px-3 py-1.5 m-1 bg-blue-200 rounded-full transition-all ease-in-out duration-300 text-xs hover:bg-yellow-500">
                ADD
            </button>
        </div>
    </div>
</div>

<div class="text-xs m-12 p-6 max-w-screen-md space-y-2 text-center">
    <p>
        Music found at
        <a href="https://freemusicarchive.org" target="_blank" class="text-blue-700">freemusicarchive.org</a>
        is licensed under a
        <a href="https://creativecommons.org/licenses/by-sa/3.0/us/" target="_blank" class="text-blue-700">
            creative commons license.
        </a>
    </p>
    <p class="">
        View source at
        <a href="https://github.com/jason00111" target="_blank" class="text-blue-700">
            GitHub <img alt="View source on GitHub" src="icons/GitHub-Mark-64px.png" class="h-4 inline">
        </a>
    </p>
</div>
<script>
    // Music found at freemusicarchive.org is licensed under a creative commons license
    // https://creativecommons.org/licenses/by-sa/3.0/us/
    const songs = [
        {
            name: 'Sláinte - Mairi\'s Wedding',
            path: 'audio/Sláinte - Mairi\'s Wedding.mp3',
            id: generateId(),
        },
        {
            name: 'Sláinte - Banish',
            path: 'audio/Sláinte - Banish.mp3',
            id: generateId(),
        },
        {
            name: 'Oak Ash and Thorn - Geordie',
            path: 'audio/Oak Ash and Thorn - Geordie.mp3',
            id: generateId(),
        },
        {
            name: 'Advent Chamber Orchestra - Handel - Entrance to the Queen of Sheba for Two Oboes, Strings, and Continuo allegro',
            path: 'audio/Advent Chamber Orchestra - Handel - Entrance to the Queen of Sheba for Two Oboes%2C Strings%2C and Continuo allegro.mp3',
            id: generateId(),
        },
        {
            name: 'Advent Chamber Orchestra - Vivaldi - Credo Crucifixus',
            path: 'audio/Advent Chamber Orchestra - Vivaldi - Credo Crucifixus.mp3',
            id: generateId(),
        },
        {
            name: 'John Harrison with the Wichita State University Chamber Players - Vivaldi - Winter Mvt 2 Largo',
            path: 'audio/John Harrison with the Wichita State University Chamber Players - Winter Mvt 2 Largo.mp3',
            id: generateId(),
        }
    ];

    const ACTIVE_ICON_CLASS = 'text-yellow-500';
    const VOLUME_FADE_TIME_CONSTANT = 0.05;

    const audioElement = document.getElementById('audio');
    const playPauseButton = document.getElementById('playPauseButton');
    const playPath = document.getElementById('playPath');
    const pausePath = document.getElementById('pausePath');
    const previousButton = document.getElementById('previousButton');
    const nextButton = document.getElementById('nextButton');
    const volumeIcon = document.getElementById('volumeIcon');
    const shuffleButton = document.getElementById('shuffleButton');
    const volumeSlider = document.getElementById('volume');
    const volumeMutePath = document.getElementById('volumeMutePath');
    const volumeHalfPath = document.getElementById('volumeHalfPath');
    const volumeFullPath = document.getElementById('volumeFullPath');
    const songListElement = document.getElementById('songList');
    const songTemplateElement = document.getElementById('songTemplate');
    const songNameElement = document.getElementById('songName');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const visualization = document.getElementById('visualization');
    const addSongUrl = document.getElementById('addSongUrl');
    const addSongName = document.getElementById('addSongName');
    const addSongFromWebButton = document.getElementById('addSongFromWebButton');

    const audioContext = new AudioContext();
    const masterGain = audioContext.createGain();
    masterGain.connect(audioContext.destination);

    const state = {
        playing: false,
        mute: false,
        volume: 1,
        shuffle: false,
        playedSongs: [],
        volumeIcon: undefined,
    }


    /*
     *  Setup Controls
     */

    playPauseButton.addEventListener('click', togglePlay);
    previousButton.addEventListener('click', playPreviousSong);
    nextButton.addEventListener('click', playNextSong);
    volumeIcon.addEventListener('click', toggleMute);
    shuffleButton.addEventListener('click', toggleShuffle);
    volumeSlider.addEventListener('input', setVolume);
    progressContainer.addEventListener('click', handleProgressClick);
    audioElement.addEventListener('ended', playNextSong);
    addSongFromWebButton.addEventListener('click', addSongFromWeb);

    [
        playPauseButton,
        previousButton,
        nextButton,
        volumeIcon,
        shuffleButton,
        progressContainer,
        songTemplateElement,
    ].forEach(button => button.addEventListener('click', playClick));

    function togglePlay() {
        if (state.playing) {
            pause();
        } else {
            play();
        }
    }

    function play() {
        state.playing = true;
        audioElement.play();

        playPath.classList.add('hidden');
        pausePath.classList.remove('hidden');
    }

    function pause() {
        state.playing = false;
        audioElement.pause();

        pausePath.classList.add('hidden');
        playPath.classList.remove('hidden');
    }

    function toggleShuffle() {
        if (state.shuffle) {
            state.shuffle = false;
            shuffleButton.classList.remove(ACTIVE_ICON_CLASS);
        } else {
            state.shuffle = true;
            shuffleButton.classList.add(ACTIVE_ICON_CLASS);
        }
    }

    function handleProgressClick(event) {
        const box = progressContainer.getBoundingClientRect();

        audioElement.currentTime = ((event.x - box.left) / box.width) * audioElement.duration;
    }

    function addSongFromWeb() {
        let name;

        if (addSongName.value.trim() === '') {
            name = (new URL(addSongUrl.value)).pathname.split('/').slice(-1)[0].split('.')[0];
        } else {
            name = addSongName.value;
        }

        songs.push({
            path: addSongUrl.value,
            name: name,
            id: generateId(),
        });

        populateSongList();

        addSongUrl.value = '';
        addSongName.value = '';
    }

    function generateId() {
        return Math.floor(Math.random() * 1e16).toString();
    }

    function populateSongList() {
        while (songListElement.firstChild) {
            songListElement.removeChild(songListElement.firstChild);
        }

        songs.forEach((song) => {
            const songElement = songTemplateElement.cloneNode(true);
            const songNameElement = songElement.getElementsByClassName('songName')[0];
            const removeButton = songElement.getElementsByClassName('removeButton')[0];
            const moveUpButton = songElement.getElementsByClassName('moveUpButton')[0];
            const moveDownButton = songElement.getElementsByClassName('moveDownButton')[0];

            songElement.dataset.songId = song.id;
            songElement.classList.remove('hidden');
            songNameElement.textContent = song.name;

            songElement.addEventListener('click', event => {
                const songElement = event.target.classList.contains('songName')
                    ? event.target.parentElement
                    : event.target;

                setSong(songElement.dataset.songId);
                play();
            });

            removeButton.addEventListener('click', event => {
                event.stopPropagation();
                removeSong(event.target.parentElement.parentElement.dataset.songId);
            });

            moveUpButton.addEventListener('click', event => {
                event.stopPropagation();
                moveSongUp(event.target.parentElement.parentElement.dataset.songId);
            });

            moveDownButton.addEventListener('click', event => {
                event.stopPropagation();
                moveSongDown(event.target.parentElement.parentElement.dataset.songId);
            });

            [
                removeButton,
                moveUpButton,
                moveDownButton,
            ].forEach(button => button.addEventListener('click', playClick));

            songListElement.append(songElement);
        });

        highlightSelectedSong();
    }

    function removeSong(songId) {
        const songIndex = songs.findIndex(song => song.id === songId);
        songs.splice(songIndex, 1);
        populateSongList();
    }

    function moveSongUp(songId) {
        const songIndex = songs.findIndex(song => song.id === songId);

        const newSongIndex = songIndex === 0 ? songs.length - 1 : songIndex - 1;

        const [removedSong] = songs.splice(songIndex, 1);
        songs.splice(newSongIndex, 0, removedSong);

        populateSongList();
    }

    function moveSongDown(songId) {
        const songIndex = songs.findIndex(song => song.id === songId);

        const newSongIndex = (songIndex + 1) % songs.length;

        const [removedSong] = songs.splice(songIndex, 1);
        songs.splice(newSongIndex, 0, removedSong);

        populateSongList();
    }

    function setSong(songId) {
        const song = songs.find(song => song.id === songId);

        if (!song) {
            console.log(`Couldn't find song ${songId}`);

            playPreviouslyPlayedSong();
            return;
        }

        state.playedSongs.push(songId);
        audioElement.src = song.path;
        songNameElement.textContent = song.name;
        highlightSelectedSong();
    }

    function highlightSelectedSong() {
        const SELECTED_SONG_CLASS = 'bg-yellow-500';

        songListElement.childNodes.forEach(songElement => {
            if (songElement.dataset.songId === state.playedSongs[state.playedSongs.length - 1]) {
                songElement.classList.add(SELECTED_SONG_CLASS);
            } else {
                songElement.classList.remove(SELECTED_SONG_CLASS);
            }
        });
    }

    function playNextSong() {
        if (state.shuffle) {
            setSong(getNextShuffleSong());
        } else {
            const selectedSongIndex = getSelectedSongIndex();
            const newSongIndex = (selectedSongIndex + 1) % songs.length;

            setSong(songs[newSongIndex].id);
        }

        play();
    }

    function getNextShuffleSong() {
        const recentlyPlayedSongs = state.playedSongs.slice(-songs.length / 2);
        const possibleNextSongs = songs.filter(song => !recentlyPlayedSongs.includes(song.id));

        const randomIndex = Math.floor(Math.random() * possibleNextSongs.length);

        return possibleNextSongs[randomIndex].id;
    }

    function playPreviousSong() {
        if (state.shuffle) {
            playPreviouslyPlayedSong();
        } else {
            playPreviousSongInList();
        }

        play();
    }

    function playPreviouslyPlayedSong() {
        if (state.playedSongs.length === 1) {
            return;
        }

        const previousSongId = state.playedSongs[state.playedSongs.length - 2];

        state.playedSongs.pop();
        state.playedSongs.pop();

        setSong(previousSongId);
    }

    function playPreviousSongInList() {
        const selectedSongIndex = getSelectedSongIndex();
        const newSongIndex = (selectedSongIndex - 1 + songs.length) % songs.length;

        setSong(songs[newSongIndex].id);
    }

    function getSelectedSongIndex() {
        return songs.findIndex(
            song => song.id === state.playedSongs[state.playedSongs.length - 1]
        );
    }

    function toggleMute() {
        if (state.mute) {
            state.mute = false;

            if (state.volume === 0) {
                state.volume = 0.2;
            }

            masterGain.gain.setTargetAtTime(state.volume, audioContext.currentTime, VOLUME_FADE_TIME_CONSTANT);
            volumeSlider.value = state.volume.toString();
            setVolumeIcon(state.volume);
        } else {
            state.mute = true;
            masterGain.gain.setTargetAtTime(0, audioContext.currentTime, VOLUME_FADE_TIME_CONSTANT);
            volumeSlider.value = '0';
            setVolumeIcon(0);
        }
    }

    function setVolume() {
        state.volume = Number(volumeSlider.value);

        masterGain.gain.setTargetAtTime(state.volume, audioContext.currentTime, VOLUME_FADE_TIME_CONSTANT);

        setVolumeIcon(state.volume);

        state.mute = state.volume === 0;
    }

    function setVolumeIcon(volume) {
        const normalizedVolume = volume / Number(volumeSlider.max);

        if (normalizedVolume > 0.5) {
            if (state.volumeIcon !== 0) {
                state.volumeIcon = 0;
                volumeMutePath.classList.add('hidden');
                volumeHalfPath.classList.add('hidden');
                volumeFullPath.classList.remove('hidden');
            }
        } else if (normalizedVolume > 0) {
            if (state.volumeIcon !== 1) {
                state.volumeIcon = 1;
                volumeMutePath.classList.add('hidden');
                volumeHalfPath.classList.remove('hidden');
                volumeFullPath.classList.add('hidden');
            }
        } else {
            if (state.volumeIcon !== 2) {
                state.volumeIcon = 2;
                volumeMutePath.classList.remove('hidden');
                volumeHalfPath.classList.add('hidden');
                volumeFullPath.classList.add('hidden');
            }
        }
    }


    /*
     *  Click sound
     */

    const clickDuration = 0.005;
    const clickAttackConstant = 0.001;
    const clickReleaseConstant = 0.01;
    const clickMinGain = 0;
    const clickMaxGain = 3.5;

    const clickFilter = audioContext.createBiquadFilter();
    const clickGain = audioContext.createGain();
    clickFilter.connect(clickGain);
    clickGain.connect(masterGain);

    clickFilter.type = 'bandpass';
    clickFilter.frequency.value = 440;
    clickFilter.Q.value = 8;

    clickGain.gain.value = clickMinGain;

    function playClick() {
        const buffer = audioContext.createBuffer(1, 0.2 * audioContext.sampleRate, audioContext.sampleRate);
        const bufferData = buffer.getChannelData(0);
        for (let i = 0; i < buffer.length; i++) {
            bufferData[i] = Math.random() * 2 - 1;
        }

        const bufferSource = audioContext.createBufferSource();
        bufferSource.buffer = buffer;

        bufferSource.connect(clickFilter);
        // bufferSource.connect(clickGain);
        bufferSource.start();

        const currentTime = audioContext.currentTime;

        clickGain.gain.setValueAtTime(clickMinGain, currentTime);
        clickGain.gain.setTargetAtTime(clickMaxGain, currentTime, clickAttackConstant);
        clickGain.gain.setValueAtTime(clickMaxGain, currentTime + clickDuration);
        clickGain.gain.setTargetAtTime(clickMinGain, currentTime + clickDuration, clickReleaseConstant);
    }


    /*
     *  Audio Visualization
     */

    const VISUALIZATION_HEIGHT_REM = 10;

    const songAudioSource = audioContext.createMediaElementSource(audioElement);
    const analyser = audioContext.createAnalyser();
    songAudioSource.connect(analyser);
    analyser.connect(masterGain);

    analyser.fftSize = 64;
    const freqData = new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteFrequencyData(freqData);

    function draw() {
        requestAnimationFrame(draw);

        analyser.getByteFrequencyData(freqData);

        visualization.childNodes.forEach((bandElement, index) => {
            setVisualizationBand(bandElement, freqData[index] / 255);
        });

        setProgressBar(audioElement.currentTime / audioElement.duration);
    }

    function setupVisualization() {
        for (let i = 0; i < analyser.frequencyBinCount; i++) {
            const band = document.createElement('div');
            const bandClasses = 'h-4 w-4 rounded-full';
            band.classList.add(...bandClasses.split(' '));
            visualization.append(band);
        }

        visualization.style.setProperty('height', `${VISUALIZATION_HEIGHT_REM}rem`);
    }

    function setVisualizationBand(bandElement, intensity) {
        bandElement.style.setProperty('background-color', `rgba(245, 158, 11, ${intensity})`);
        bandElement.style.setProperty('height', `${intensity * VISUALIZATION_HEIGHT_REM}rem`);
    }

    function setProgressBar(ratio) {
        progressBar.style.setProperty('width', `${progressContainer.clientWidth * ratio}px`);
    }


    /*
     *  Get Things Started
     */

    function initialize() {
        setSong(songs[0].id);
        populateSongList();
        setupVisualization();
        setProgressBar(0);
        setVolume();
        draw();
    }

    initialize();
</script>

</body>
</html>

<!-- todo
show alt text for buttons? aria?
!load local files
split into modules?
change songs to object and create song list?
directory of songs
!fix up/down/delete behavior
-->
